# Тестовая задача Alikassa (Минхаеров А.Р.)

## Установка

    cd ali_test
    composer install
    php artisan vendor:publish

    ./sail build --no-cache
    ./sail up

    ./sail artisan migrate
    ./sail artisan db:seed
    ./sail artisan storage:link
    ./sail npm install
    ./sail npm run dev

## Описание

Система учета крипто-баланса позволяет пользователям безопасно управлять своими криптовалютными средствами, включая зачисление, вывод, переводы и оплату комиссий. Система разработана с учетом специфики блокчейна, асинхронности операций и обеспечения безопасности.

## Основные возможности

- Управление балансом криптовалюты
- Резервирование средств для обеспечения целостности транзакций
- Полный аудит всех операций через историю транзакций
- Асинхронная обработка уведомлений от блокчейна через webhook
- Защита от race condition при параллельных операциях
- Ограничение частоты операций для предотвращения злоупотреблений

### API Endpoints

### Получение баланса

```
GET /balance?currency=BTC
```
**Ответ:**
```json
{
  "currency": "BTC",
  "total_balance": 1.5,
  "reserved_balance": 0.5,
  "available_balance": 1.0
}
```

### Получение истории транзакций

```
GET /balance/transactions?currency=BTC&type=deposit&limit=50
```

**Параметры:**
- `currency` (опциональный) - Валюта, по умолчанию BTC.
- `type` (опциональный) - Тип транзакции (deposit, withdrawal, transfer, reserve, release, fee, refund).
- `limit` (опциональный) - Количество записей (1-100). По умолчанию 50.

**Ответ:**
```json
{
  "transactions": [
    {
      "id": 1,
      "type": "deposit",
      "type_label": "Депозит",
      "amount": 0.5,
      "currency": "BTC",
      "balance_before": 1.0,
      "balance_after": 1.5,
      "description": "Депозит средств",
      "created_at": "2023-01-01T00:00:00.000000Z"
    }
  ]
}
```

### Получение деталей транзакции

```
GET /balance/transaction/{transactionId}
```

**Параметры:**
- `transactionId` - ID транзакции

**Ответ:**
```json
{
  "transaction": {
    "id": 1,
    "type": "deposit",
    "type_label": "Депозит",
    "amount": 0.5,
    "currency": "BTC",
    "balance_before": 1.0,
    "balance_after": 1.5,
    "reserved_before": 0,
    "reserved_after": 0,
    "description": "Депозит средств",
    "status": "completed",
    "created_at": "2023-01-01T00:00:00.000000Z"
  }
}
```

### Депозит средств

```
POST /balance/deposit
```

**Параметры:**
- `amount` (обязательный) - Сумма для зачисления
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `reference_id` (опциональный) - Внешний ID транзакции
- `description` (опциональный) - Описание транзакции

**Пример запроса:**
```json
{
  "amount": 0.5,
  "currency": "BTC",
  "reference_id": "tx_123456789",
  "description": "Депозит от пользователя"
}
```

**Ответ:**
```json
{
  "message": "Средства успешно зачислены",
  "balance": 1.5,
  "available_balance": 1.0
}
```

### Вывод средств

```
POST /balance/withdraw
```

**Параметры:**
- `amount` (обязательный) - Сумма для вывода
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `reference_id` (опциональный) - Внешний ID транзакции
- `description` (опциональный) - Описание транзакции

**Пример запроса:**
```json
{
  "amount": 0.5,
  "currency": "BTC",
  "reference_id": "tx_987654321",
  "description": "Вывод средств"
}
```

**Ответ:**
```json
{
  "message": "Средства успешно выведены",
  "balance": 1.0,
  "available_balance": 0.5
}
```

### Перевод средств другому пользователю

```
POST /balance/transfer
```

**Параметры:**
- `to_user_id` (обязательный) - ID пользователя-получателя
- `amount` (обязательный) - Сумма для перевода
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `description` (опциональный) - Описание транзакции

**Пример запроса:**
```json
{
  "to_user_id": 2,
  "amount": 0.5,
  "currency": "BTC",
  "description": "Перевод за услуги"
}
```

**Ответ:**
```json
{
  "message": "Средства успешно переведены",
  "balance": 1.0,
  "available_balance": 0.5
}
```

## Webhook-уведомления

Система принимает уведомления от блокчейна о подтверждении транзакций:

```
POST /webhook/crypto
```

**Типы уведомлений:**
- `deposit_confirmed` - Подтверждение депозита
- `withdrawal_confirmed` - Подтверждение вывода
- `deposit_failed` - Ошибка депозита
- `withdrawal_failed` - Ошибка вывода

**Пример webhook-а:**
```json
{
  "event": "deposit_confirmed",
  "user_id": 1,
  "amount": 0.5,
  "currency": "BTC",
  "transaction_id": "tx_123456789"
}
```

## Безопасность

- Все операции с балансом защищены от race condition через транзакции базы данных
- Проверка доступности средств перед резервированием
- Полное логирование всех операций
- Валидация всех входных данных
- Уникальность внешних ID транзакций
- Ограничение частоты операций для предотвращения злоупотреблений
- Аутентификация пользователей для всех операций

## Обработка ошибок

Все ошибки возвращаются в формате:
```json
{
  "error": "Описание ошибки"
}
```

Коды ошибок:
- 400 - Неверные параметры запроса
- 401 - Не авторизован
- 404 - Ресурс не найден
- 429 - Превышен лимит операций
- 500 - Внутренняя ошибка сервера

## Примеры использования

### Пополнение баланса пользователя

1. Пользователь инициирует депозит через интерфейс
2. Система резервирует средства (reserve)
3. Система получает webhook о подтверждении транзакции в блокчейне
4. Система зачисляет средства на баланс (deposit)

### Вывод средств

1. Пользователь инициирует вывод через интерфейс
2. Система резервирует средства (reserve)
3. Система списывает средства (withdrawal)
4. Система отправляет транзакцию в блокчейн
5. Система получает webhook о подтверждении транзакции

### Перевод средств между пользователями

1. Пользователь инициирует перевод другому пользователю
2. Система резервирует средства у отправителя
3. Система переводит средства получателю
4. Система создает соответствующие записи в истории транзакций обоих пользователей