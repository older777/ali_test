# Тестовая задача Alikassa (Минхаеров А.Р.)

## Установка

    cd ali_test
    composer install
    php artisan vendor:publish

    ./sail build --no-cache
    ./sail up

    ./sail artisan migrate
    ./sail artisan db:seed
    ./sail artisan storage:link
    ./sail npm install
    ./sail npm run dev

## Описание

Система учета крипто-баланса позволяет пользователям безопасно управлять своими криптовалютными средствами, включая зачисление, вывод, переводы и оплату комиссий. Система разработана с учетом специфики блокчейна, асинхронности операций и обеспечения безопасности.

## Основные возможности

- Управление балансом криптовалют (BTC, ETH, USDT)
- Резервирование средств для обеспечения целостности транзакций
- Полный аудит всех операций через историю транзакций
- Асинхронная обработка уведомлений от блокчейна через webhook-ы
- Защита от race condition при параллельных операциях
- Ограничение частоты операций для предотвращения злоупотреблений
- Поддержка комиссий за транзакции
- Отслеживание подтверждений блокчейна

## Архитектура

### Модели данных

1. **CryptoBalance** - Хранит баланс пользователей по каждой криптовалюте
2. **CryptoTransaction** - Хранит историю всех транзакций с подробной информацией

### Сервисы

1. **CryptoBalanceService** - Бизнес-логика управления балансом
2. **Middleware** - Ограничение частоты операций

### Контроллеры

1. **CryptoBalanceController** - API для управления балансом
2. **WebhookController** - Обработка уведомлений от блокчейна

## API Endpoints

### Получение баланса

```
GET /balance?currency=BTC
```

**Параметры:**
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.

**Ответ:**
```json
{
  "currency": "BTC",
  "total_balance": 1.5,
  "reserved_balance": 0.5,
  "available_balance": 1.0
}
```

### Получение истории транзакций

```
GET /balance/transactions?currency=BTC&type=deposit&limit=50
```

**Параметры:**
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `type` (опциональный) - Тип транзакции (deposit, withdrawal, transfer, reserve, release, fee, refund).
- `limit` (опциональный) - Количество записей (1-100). По умолчанию 50.

**Ответ:**
```json
{
  "transactions": [
    {
      "id": 1,
      "type": "deposit",
      "type_label": "Депозит",
      "amount": 0.5,
      "currency": "BTC",
      "balance_before": 1.0,
      "balance_after": 1.5,
      "description": "Депозит средств",
      "created_at": "2023-01-01T00:00:00.000000Z"
    }
  ]
}
```

### Получение деталей транзакции

```
GET /balance/transaction/{transactionId}
```

**Параметры:**
- `transactionId` - ID транзакции

**Ответ:**
```json
{
  "transaction": {
    "id": 1,
    "type": "deposit",
    "type_label": "Депозит",
    "amount": 0.5,
    "currency": "BTC",
    "balance_before": 1.0,
    "balance_after": 1.5,
    "reserved_before": 0,
    "reserved_after": 0,
    "description": "Депозит средств",
    "status": "completed",
    "created_at": "2023-01-01T00:00:00.000000Z"
  }
}
```

### Депозит средств

```
POST /balance/deposit
```

**Параметры:**
- `amount` (обязательный) - Сумма для зачисления
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `reference_id` (опциональный) - Внешний ID транзакции
- `description` (опциональный) - Описание транзакции

**Пример запроса:**
```json
{
  "amount": 0.5,
  "currency": "BTC",
  "reference_id": "tx_123456789",
  "description": "Депозит от пользователя"
}
```

**Ответ:**
```json
{
  "message": "Средства успешно зачислены",
  "balance": 1.5,
  "available_balance": 1.0,
  "transaction_id": 1
}
```

### Вывод средств

```
POST /balance/withdraw
```

**Параметры:**
- `amount` (обязательный) - Сумма для вывода
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `reference_id` (опциональный) - Внешний ID транзакции
- `description` (опциональный) - Описание транзакции

**Пример запроса:**
```json
{
  "amount": 0.5,
  "currency": "BTC",
  "reference_id": "tx_987654321",
  "description": "Вывод средств"
}
```

**Ответ:**
```json
{
  "message": "Средства успешно выведены",
  "balance": 1.0,
  "available_balance": 0.5,
  "fee": 0.0001,
  "transaction_id": 2
}
```

### Перевод средств другому пользователю

```
POST /balance/transfer
```

**Параметры:**
- `to_user_id` (обязательный) - ID пользователя-получателя
- `amount` (обязательный) - Сумма для перевода
- `currency` (опциональный) - Валюта (BTC, ETH, USDT). По умолчанию BTC.
- `description` (опциональный) - Описание транзакции

**Пример запроса:**
```json
{
  "to_user_id": 2,
  "amount": 0.5,
  "currency": "BTC",
  "description": "Перевод за услуги"
}
```

**Ответ:**
```json
{
  "message": "Средства успешно переведены",
  "balance": 1.0,
  "available_balance": 0.5,
  "from_transaction_id": 3,
  "to_transaction_id": 4
}
```

## Webhook-уведомления

Система принимает уведомления от блокчейна о подтверждении транзакций:

```
POST /webhook/crypto
```

**Заголовки:**
- `X-Signature` - Подпись webhook для проверки подлинности

**Типы уведомлений:**
- `deposit_confirmed` - Подтверждение депозита
- `withdrawal_confirmed` - Подтверждение вывода
- `deposit_failed` - Ошибка депозита
- `withdrawal_failed` - Ошибка вывода

**Пример webhook-а для подтвержденного депозита:**
```json
{
  "event": "deposit_confirmed",
  "user_id": 1,
  "amount": 0.5,
  "currency": "BTC",
  "transaction_id": "tx_123456789",
  "blockchain_tx_id": "0x123456789abcdef",
  "confirmations": 3,
  "description": "Confirmed deposit from blockchain"
}
```

**Пример webhook-а для подтвержденного вывода:**
```json
{
  "event": "withdrawal_confirmed",
  "transaction_id": "tx_987654321",
  "blockchain_tx_id": "0x987654321abcdef",
  "confirmations": 6
}
```

## Безопасность

### Защита от race condition
Все операции с балансом выполняются в транзакциях базы данных для обеспечения целостности данных при параллельных запросах.

### Резервирование средств
Перед выполнением операций вывода и переводов средства резервируются для предотвращения двойных расходов.

### Валидация данных
Все входные данные проходят строгую валидацию на стороне сервера.

### Ограничение частоты операций
Реализована система ограничения частоты операций для предотвращения злоупотреблений:
- Депозиты: 10 в час
- Выводы: 5 в час
- Переводы: 20 в час
- Общие операции: 60 в час

### Аудит транзакций
Все операции логируются с подробной информацией о балансе до и после операции.

## Конфигурация

### Поддерживаемые криптовалюты
Система поддерживает следующие криптовалюты:
- **BTC** (Bitcoin)
- **ETH** (Ethereum)
- **USDT** (Tether)

### Минимальные суммы
- BTC: 0.00000001
- ETH: 0.000000000000000001
- USDT: 0.000001

### Комиссии за вывод
- BTC: 0.0001
- ETH: 0.001
- USDT: 1

## Обработка ошибок

Все ошибки возвращаются в формате:
```json
{
  "error": "Описание ошибки"
}
```

Коды ошибок:
- 400 - Неверные параметры запроса
- 401 - Не авторизован
- 404 - Ресурс не найден
- 429 - Превышен лимит операций
- 500 - Внутренняя ошибка сервера

## Примеры использования

### Пополнение баланса пользователя

1. Пользователь инициирует депозит через интерфейс
2. Система создает запись о резервировании средств
3. Система получает webhook о подтверждении транзакции в блокчейне
4. Система зачисляет средства на баланс

### Вывод средств

1. Пользователь инициирует вывод через интерфейс
2. Система резервирует средства с учетом комиссии
3. Система списывает средства и комиссию
4. Система отправляет транзакцию в блокчейн
5. Система получает webhook о подтверждении транзакции

### Перевод средств между пользователями

1. Пользователь инициирует перевод другому пользователю
2. Система резервирует средства у отправителя
3. Система переводит средства получателю
4. Система создает соответствующие записи в истории транзакций обоих пользователей

## Тестирование

Система включает в себя полный набор тестов:
- Unit тесты для сервисного класса
- Feature тесты для API endpoints
- Feature тесты для webhook обработчиков

Для запуска тестов выполните:
```bash
php artisan test
```

## Развертывание

1. Выполните миграции базы данных:
```bash
php artisan migrate
```

2. При необходимости заполните тестовые данные:
```bash
php artisan db:seed
```

3. Настройте webhook URL в вашем блокчейн провайдере:
```
https://your-domain.com/webhook/crypto
```

4. Установите секретный ключ для webhook в .env:
```
BLOCKCHAIN_WEBHOOK_SECRET=your_secret_key
```